# img-watermarking-test

Данный проект предназначен для тестирования методов маркирования изображений.

Примеры можно найти в директории `scripts/`

Результаты загружаются в базу данных Clickhouse, с возможностью последующего анализа в DataLens

## Установка

1. Установить [json2clickhouse](https://gitlab.ispras.ru/discopal/jsons2clickhouse)
2. Установить пакет

```python
pip install -e .
```

pip

## Как протестировать свой алгоритм

### 1. Создать таблицу для своего алгоритма в базе данных Clickhouse

Можно при помощи [DBeaver](https://dbeaver.io/):

1. Создать новое подключение, тип **ClickHouse**
2. Задать **Host**, см **dburl** в ".ini" файле (например, **dm-lab-2.intra.ispras.ru**), Username: **default**
3. ПКМ по базе **image_watermarking** -> SQL editor -> Open SQL Script, запустить скрипт создания таблицы, например, такой:

```sql
CREATE TABLE тут_название_таблицы
(
    `dtm` DateTime64(3),
)
ENGINE = MergeTree
PRIMARY KEY (dtm)
ORDER BY (dtm)
SETTINGS index_granularity = 8192;
```

4. Создать соответствующий ".ini" файл (см. директорию `scripts`)

### 2. Подготовить скрипт для тестирования

Основной класс для тестирования - **Pipeline** из модуля **im_test.pipeline**:

```python
Pipeline(
    algorithm_wrapper: AlgorithmWrapper | Iterable[AlgorithmWrapper],
    dataset: Dataset,
    augmentations: list[tuple[str, Callable]],
    metrics: list[Metric],
    result_path: Path | str,
    db_config: Path | str,
)
```

* `algorithm_wrapper` - инстанс класса, унаследованного от **im_test.algorithm_wrapper.AlgorithmWrapper** - класса-обертки для запуска алгоритма (либо перечисляемый объект для тестирования нескольких наборов параметров). Должен удовлетворять следующим условиям:
  * В `__init__` производится вызов `__init__` родительского класса **AlgorithmWrapper**, в который передается объект, содержащий логируемые параметры алгоритма (значения этих параметров, а также их совокупный хеш заносятся в итоговую таблицу). В настоящий момент реализована поддержка **словарей** и **датаклассов**, однако возможна поддержка произвольного типа, если в наследующем классе переопределить метод `params2dict`
  * Реализован метод `embed` с аргументами `image` (np.uint8 BGR numpy-массив маркируемого изображения) и `watermark_data` (произвольные данные, необходимые для маркирования, например, битовая последовательность в качестве сообщения или ключ). Возвращает маркированное изображение (np.uint8 BGR numpy-массив)
  * Реализован метод `extract` с аргументами `image` (np.uint8 BGR numpy-массив маркируемого изображения) и `watermark_data` (произвольные данные, необходимые для маркирования, например, битовая последовательность в качестве сообщения или ключ). Возвращает некоторый результат работы алгоритма извлечения (в последующем используется для рассчета метрик)
  * Реализован метод `watermark_data_gen`, генерирующий `watermark_data`. Например, случайная битовая строка определенного размера.
* `dataset` - инстанс класса унаследованного от **im_test.datasets.Dataset**
* `augmentations` - список аугментаций, применяемых к изображениям в процессе тестирования
* `metrics` - список метрик, рассчитываемых в ходе тестирования. Поддерживаются 2 вида метрик:
  * метрики, унаследованные от **im_test.metrics.PostEmbedMetric**: рассчитываются после внедрения метки в изображение. Получают на вход исходное изображение, маркированное изображение и данные маркирования `watermark_data`
  * метрики, унаследованные от **im_test.metrics.PostExtractMetric**: рассчитываются после извлечения метки. Получают на вход исходное изображение, маркированное изображение, данные маркирования `watermark_data` и результат работы алгоритма извлечения.
* `result_path` - путь к директории для сохранения результатов (если их не удалось отправить)
* `db_config` - путь к ".ini" файлу конфигурации подключения к базе данных.

### 3. Запустить скрипт, проверить соответвующую таблицу в БД

По умолчанию отправка происходит после того, как наберется 100 записей. Таблица должна содежать следущие поля:

* `dtm` - время запуска теста для изображения
* `run_id` - идентификатор запуска (формируется на основе времени и хоста)
* `img_id` - идентификатор изображения (определен в датасете)
* `param_hash` - md5 хеш от параметров алгоритма маркирования
* `embedded` - 1, если маркирования произошло успешно, 0, если возникла ошибка
* `embed_time` - время работы алгоритма маркирования
* `params_{название параметра}` - значение параметра
* `{название post_embed метрики}` - значение метрики, рассчитываемой после внедрения
* `{название аугментации}_extracted` - 1, если извлечение после применения аугментации произошло без ошибок (не обязательно правильно), 0, если возникла ошибка
* `{название аугментации}_extract_time` - время работы алгоритма извлечения на изображении после аугментации
* `{название аугментации}_{название post_extract метрики}`- значение метрики, рассчитываемой после извлечения
